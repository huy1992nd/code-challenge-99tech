echo "Running ESLint (staged TS/TSX in src/problem5) and tests on pre-commit..."

# Collect staged TS/TSX files within src/problem5
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^src/problem5/.*\.(ts|tsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
	echo "No staged TypeScript files under src/problem5. Skipping lint and tests."
	exit 0
fi

if [ -n "$STAGED_FILES" ]; then
	echo "Linting:"
	echo "$STAGED_FILES" | sed 's/^/ - /'

	# Run ESLint with fixes using flat config
	npx --yes eslint --fix --max-warnings=0 $STAGED_FILES || exit 1

	# Re-add potentially fixed files to the commit
	git add $STAGED_FILES || exit 1
fi

cd src/problem5 || exit 1

if [ ! -d node_modules ]; then
	echo "Installing dependencies in src/problem5..."
	npm ci --no-audit --no-fund || exit 1
fi

npm run -s prisma:generate || exit 1

npm test || exit 1
